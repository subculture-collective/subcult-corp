# ─── SUBCULT-CORP — Docker Compose ───
services:
    # ── PostgreSQL ──
    postgres:
        image: postgres:16-alpine
        container_name: subcult-postgres
        restart: unless-stopped
        env_file:
            - .env.local
        environment:
            POSTGRES_USER: subcult
            POSTGRES_DB: subcult_ops
        ports:
            - '127.0.0.1:5433:5432'
        volumes:
            - pgdata:/var/lib/postgresql/data
        healthcheck:
            test: ['CMD-SHELL', 'pg_isready -U subcult -d subcult_ops']
            interval: 10s
            timeout: 5s
            retries: 5
        networks:
            - internal

    # ── OpenClaw Gateway Bridge ──
    # Reads JSONL/logs from bind-mounted OpenClaw directories via inotify
    # and inserts ops_agent_events rows into Postgres over the internal network.
    # See the openclaw-bridge service definition below.

    # ── Next.js App ──
    app:
        build: .
        container_name: subcult-app
        restart: unless-stopped
        depends_on:
            postgres:
                condition: service_healthy
        env_file:
            - .env.local
        networks:
            - web
            - internal

    # ── Roundtable Conversation Worker ──
    roundtable-worker:
        build: .
        container_name: subcult-roundtable
        restart: unless-stopped
        command: ['node', 'scripts/roundtable-worker/worker.mjs']
        depends_on:
            postgres:
                condition: service_healthy
        env_file:
            - .env.local
        networks:
            - internal

    # ── Mission Step Executor Worker ──
    mission-worker:
        build: .
        container_name: subcult-mission
        restart: unless-stopped
        command: ['node', 'scripts/mission-worker/worker.mjs']
        depends_on:
            postgres:
                condition: service_healthy
        env_file:
            - .env.local
        networks:
            - internal

    # ── Initiative Worker ──
    initiative-worker:
        build: .
        container_name: subcult-initiative
        restart: unless-stopped
        command: ['node', 'scripts/initiative-worker/worker.mjs']
        depends_on:
            postgres:
                condition: service_healthy
        env_file:
            - .env.local
        networks:
            - internal

    # ── OpenClaw Event Bridge ──
    openclaw-bridge:
        build:
            context: /home/onnwee/.openclaw/bridge
        container_name: subcult-oc-bridge
        restart: unless-stopped
        depends_on:
            postgres:
                condition: service_healthy
        env_file:
            - .env.local
        environment:
            PGHOST: postgres
            PGPORT: '5432'
            PGDATABASE: subcult_ops
            PGUSER: subcult
            OPENCLAW_HOME: /data/openclaw
            BRIDGE_DIR: /data/bridge
        volumes:
            - /home/onnwee/.openclaw/cron/runs:/data/openclaw/cron/runs:ro
            - /home/onnwee/.openclaw/cron/jobs.json:/data/openclaw/cron/jobs.json:ro
            - /home/onnwee/.openclaw/logs:/data/openclaw/logs:ro
            - /home/onnwee/.openclaw/agents:/data/openclaw/agents:ro
            - /home/onnwee/.openclaw/workspace/skills/topic-monitor/.data:/data/openclaw/workspace/skills/topic-monitor/.data:ro
            - /home/onnwee/.openclaw/bridge:/data/bridge
        networks:
            - internal

volumes:
    pgdata:

networks:
    web:
        external: true
    internal:
        driver: bridge
